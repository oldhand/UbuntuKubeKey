---
- name: Install kubeadm kubelet
  apt:
    name: 
      - kubeadm
      - kubelet
      - cri-tools
    state: present
  when: is_worker == 1



# 新增任务：加载本地Kubernetes镜像
- name: 复制本地镜像文件到临时目录
  copy:
    src: "{{ playbook_dir }}/images/{{ item }}"
    dest: "/tmp/{{ item }}"
    mode: 0644
    directory_mode: 0755           # 为目录设置单独的权限（可选）
    remote_src: no         # 表示src是本地路径，不是远程路径
    force: yes             # 如果目标存在则覆盖
  with_items:
    - "kube-apiserver-v1.29.3.tar"
    - "kube-controller-manager-v1.29.3.tar"
    - "kube-scheduler-v1.29.3.tar"
    - "kube-proxy-v1.29.3.tar"
    - "pause-3.9.tar"
    - "etcd-3.5.16-0.tar"
    - "coredns-v1.11.1.tar"
  when: is_worker == 1  # 所有节点都需要加载

- name: 加载本地镜像到Docker
  shell: "docker load -i /tmp/{{ item }}"
  with_items:
    - "kube-apiserver-v1.29.3.tar"
    - "kube-controller-manager-v1.29.3.tar"
    - "kube-scheduler-v1.29.3.tar"
    - "kube-proxy-v1.29.3.tar"
    - "pause-3.9.tar"
    - "etcd-3.5.16-0.tar"
    - "coredns-v1.11.1.tar"
  when: is_worker == 1  # 所有节点都需要加载

- name: Install kubectl
  apt:
    name: kubectl
    state: present
  when: is_master == 1

- name: 确保Ubuntu的kubelet配置目录存在
  file:
    path: /etc/default
    state: directory
    mode: '0755'
  when: is_worker == 1

- name: Kubelet configuration (Ubuntu)
  copy:
    src: kubelet
    dest: /etc/default/kubelet  # Ubuntu默认使用/etc/default/目录
  when: is_worker == 1

- name: Enable kubelet
  systemd: 
    name: kubelet.service
    enabled: yes
  when: is_worker == 1
  notify:
    - Restart OS
    - Wait for server come back

- name: Flush handlers
  meta: flush_handlers

